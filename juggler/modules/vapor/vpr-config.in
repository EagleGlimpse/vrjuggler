#!@PERL@ -w

# ***************** <VPR heading BEGIN do not edit this line> *****************
#
# VR Juggler Portable Runtime
#
# Original Authors:
#   Allen Bierbaum, Patrick Hartling, Kevin Meinert, Carolina Cruz-Neira
#
# -----------------------------------------------------------------
# File:          $RCSfile$
# Date modified: $Date$
# Version:       $Revision$
# -----------------------------------------------------------------
#
# ****************** <VPR heading END do not edit this line> ******************

# ************** <auto-copyright.pl BEGIN do not edit this line> **************
#
# VR Juggler is (C) Copyright 1998-2002 by Iowa State University
#
# Original Authors:
#   Allen Bierbaum, Christopher Just,
#   Patrick Hartling, Kevin Meinert,
#   Carolina Cruz-Neira, Albert Baker
#
# This library is free software; you can redistribute it and/or
# modify it under the terms of the GNU Library General Public
# License as published by the Free Software Foundation; either
# version 2 of the License, or (at your option) any later version.
#
# This library is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
# Library General Public License for more details.
#
# You should have received a copy of the GNU Library General Public
# License along with this library; if not, write to the
# Free Software Foundation, Inc., 59 Temple Place - Suite 330,
# Boston, MA 02111-1307, USA.
#
# *************** <auto-copyright.pl END do not edit this line> ***************

use 5.004;

use strict 'vars';
use vars qw($ECHO_CXXFLAGS $ECHO_EXEC_PREFIX $ECHO_EXTRA_LIBS $ECHO_LIBS
            $ECHO_PREFIX);
use vars qw($exec_prefix $EXEC_PREFIX_SET $prefix $PREFIX_SET $LIBBITSUF
            $VPR_ABI_FLAGS $VPR_ISA_FLAGS $Win32 $PATH_SEP);

use File::Basename;
use Getopt::Long;

sub usage($);
sub make_CXXFLAGS($;$);
sub make_INCLUDES($);
sub make_LDFLAGS($;$$$);
sub make_EXTRA_LDFLAGS($;$);
sub handleOptArg($$);

# TODO: Do not use @prefix@ if possible.  Make use of @LOCAL_BOOST@.

usage(1) if $#ARGV == -1;

my $vpr_default_abi = "@ABI@";
my $vpr_default_isa = "@ISA@";
my $vpr_n32_flags   = "@vpr_n32_flags@";
my $vpr_64_flags    = "@vpr_64_flags@";
$LIBBITSUF          = '@LIBBITSUF@';

my $use_gcc = '@USE_GCC@';

$VPR_ABI_FLAGS = '';

if ( $vpr_default_abi =~ /n32/i )
{
   $VPR_ABI_FLAGS = "$vpr_n32_flags";
}
elsif ( $vpr_default_abi =~ /64/ )
{
   $VPR_ABI_FLAGS = "$vpr_64_flags";
}

$VPR_ISA_FLAGS = '';

# If we are not using GCC and a known ISA is defined, add define the ISA
# argument for the compiler and linker.
if ( $use_gcc !~ /^y/i && $vpr_default_isa =~ /^mips[34]/ )
{
   $VPR_ISA_FLAGS = "-$vpr_default_isa";
}

# Set up variables used to determine what the real prefix is.  This is
# important when this script has been installed.
$Win32    = (defined($ENV{'OS'}) && "$ENV{'OS'}" eq "Win32");
$PATH_SEP = ($Win32 ? "\\" : "/");

my $base_dir = (fileparse("$0"))[1];
$base_dir    =~ s|$PATH_SEP$||o;       # Strip off the trailing slash
$base_dir    =~ s|${PATH_SEP}bin$||io; # If the path ends in "/bin", strip it

# $exec_prefix may refer to $prefix, so it must be set after $prefix is
# defined.
$prefix      = "$base_dir";
$exec_prefix = "@exec_prefix@";

$ECHO_PREFIX      = 0;
$ECHO_EXEC_PREFIX = 0;
$PREFIX_SET       = 0;
$EXEC_PREFIX_SET  = 0;
$ECHO_CXXFLAGS    = 0;
$ECHO_LIBS        = 0;
$ECHO_EXTRA_LIBS  = 0;

my $script_help    = 0;
my $print_all      = 0;
my $echo_includes  = 0;
my $echo_subsystem = 0;
my $echo_version   = 0;
my $echo_static    = 0;
my $use_base_dir   = 0;
my $use_linker     = 0;

my $cxxflags_arg   = '';
my $libs_arg       = '';
my $extra_libs_arg = '';

# This is special syntax that will get replaced by the configure script based
# on whether or not the base directory should be used by default.
%{
%}

GetOptions('help|?' => \$script_help, 'all' => \$print_all,
           'basedir' => \$use_base_dir, 'version' => \$echo_version,
           'subsystem' => \$echo_subsystem, 'prefix:s' => \&handleOptArg,
           'exec-prefix:s' => \&handleOptArg, 'cxxflags:s' => \&handleOptArg,
           'includes' => \$echo_includes, 'libs:s' => \&handleOptArg,
           'extra-libs:s' => \&handleOptArg, 'linker' => \$use_linker,
           'static' => \$echo_static);

usage(0) if $script_help;

# If we are using $VPR_BASE_DIR, overwrite $prefix and $exec_prefix unless
# they were set explicitly on the command line.
if ( $use_base_dir )
{
   die "ERROR: \$VPR_BASE_DIR not set" unless defined($ENV{'VPR_BASE_DIR'});
   $prefix      = "$ENV{'VPR_BASE_DIR'}" unless $PREFIX_SET;
   $exec_prefix = "$ENV{'VPR_BASE_DIR'}" unless $EXEC_PREFIX_SET;
}

# Construct the (potentially complex) strings that may be printed.
my $cxxflags      = make_CXXFLAGS("$cxxflags_arg", $use_base_dir);
my $includes      = make_INCLUDES("$cxxflags");
my $ldflags       = make_LDFLAGS("$libs_arg", $echo_static, $use_base_dir,
                                 $use_linker);
my $extra_ldflags = make_EXTRA_LDFLAGS("$extra_libs_arg", $use_linker);

# Finally, print out the requested information.
print "$prefix\n" if $ECHO_PREFIX;
print "$exec_prefix\n" if $ECHO_EXEC_PREFIX;
print "@SUBSYSTEM@\n" if $echo_subsystem;
print "@MAJOR_VERSION@.@MINOR_VERSION@.@MICRO_VERSION@\n" if $echo_version;
print "$cxxflags\n" if $ECHO_CXXFLAGS;
print "$includes\n" if $echo_includes;
print "$ldflags\n" if $ECHO_LIBS;
print "$extra_ldflags\n" if $ECHO_EXTRA_LIBS;

exit(0);

# =============================================================================
# Subroutines follow.
# =============================================================================

sub usage ($)
{
    print <<EOF;
Usage: $0 [OPTIONS] [LIBRARIES]
Options:
        [--basedir]             Use \$VPR_BASE_DIR when printing paths
        [--prefix[=DIR]]        Print the installation prefix or set an
                                alternate prefix to use when printing paths
        [--exec-prefix[=DIR]]   Print the executable prefix or set an
                                alternate executable prefix to use when
                                printing paths
        [--version]             Print the installed VPR's version number
        [--cxxflags [N32|64]]   Print the VPR-specific flags for the C++
                                compiler
        [--includes]            Print out only the header path extension
                                arguments
        [--libs [N32|64]]       Print the basic VPR-specific libraries
        [--extra-libs [N32|64]] Print the extra linker options needed for
                                making an executable
        [--all]                 Print all the flags used for compiling or
                                linking (depending on other options)
        [--linker]              Print libraries as direct arguments to the
                                linker rather than to the compiler
        [--subsystem]           Print the OS abstraction layer being used
EOF

    exit($_[0]);
}

sub make_CXXFLAGS ($;$)
{
   my $cxxflags_arg = shift;
   my $use_base_dir = shift || 0;

   my $cxxflags = '';

   # Default setting from configure.
   my $vpr_extra_cxxflags = "@vpr_extra_cxxflags@";

   if ( $cxxflags_arg =~ /n32/i )
   {
      $vpr_extra_cxxflags = "$vpr_extra_cxxflags $vpr_n32_flags $VPR_ISA_FLAGS";
   }
   elsif ( $cxxflags_arg =~ /64/ )
   {
      $vpr_extra_cxxflags = "$vpr_extra_cxxflags $vpr_64_flags $VPR_ISA_FLAGS";
   }
   elsif ( "$cxxflags_arg" eq '' )
   {
      $vpr_extra_cxxflags = "$vpr_extra_cxxflags $VPR_ABI_FLAGS $VPR_ISA_FLAGS";
   }

   my $vpr_extra_include_dirs     = "@vpr_extra_include_dirs@";
   my $vpr_extra_includes         = '';
   my $vpr_basedir_extra_includes = '';

   if ( "$vpr_extra_include_dirs" ne "" )
   {
      my $dir;
      foreach $dir ( split(/\s+/, "$vpr_extra_include_dirs") )
      {
         $vpr_extra_includes         .= " -I@includedir@/$dir";
         $vpr_basedir_extra_includes .= " -I$ENV{'VPR_BASE_DIR'}/include/$dir"
            if defined($ENV{'VPR_BASE_DIR'});
      }
   }

   $cxxflags =
      "@vpr_cxxflags@ $vpr_extra_cxxflags @subsystem_cxxflags@ " .
      ($use_base_dir ? "-I$ENV{'VPR_BASE_DIR'}/include $vpr_basedir_extra_includes"
                     : "-I@includedir@ $vpr_extra_includes");

   # Strip out extra whitespace.
   $cxxflags =~ s/\s{2,}/ /g;

   return "$cxxflags";
}

sub make_INCLUDES ($)
{
   my(@compiler_flags) = split(/\s+/, "$_[0]");
   return join(" ", grep(/^-I/, @compiler_flags));
}

sub make_LDFLAGS ($;$$$)
{
   my $libs_arg     = shift;
   my $echo_static  = shift || 0;  # Echo static linking flags
   my $use_base_dir = shift || 0;  # Use $ENV{'VPR_BASE_DIR'} for the path
   my $use_linker   = shift || 0;  # Use flags for direct use of the linker

   my $static_begin = '';
   my $static_end   = '';

   if ( $echo_static )
   {
      $static_begin = '@static_begin@';
      $static_end   = '@static_end@';
   }

   my $ldflags = '';

   if ( $libs_arg =~ /n32/i )
   {
      $ldflags   = "$vpr_n32_flags $VPR_ISA_FLAGS";
      $LIBBITSUF = '32';
   }
   elsif ( $libs_arg =~ /64/ )
   {
      $ldflags   = "$vpr_64_flags $VPR_ISA_FLAGS";
      $LIBBITSUF = '64';
   }
   elsif ( "$libs_arg" eq '' )
   {
      $ldflags = "$VPR_ABI_FLAGS $VPR_ISA_FLAGS";
   }

   if ( $use_base_dir )
   {
      $ldflags .= " -L$ENV{'VPR_BASE_DIR'}/lib$LIBBITSUF";
   }
   else
   {
      $ldflags .= ($use_linker ? " @vpr_ldflags_linker@"
                               : " @vpr_ldflags_compiler@");
   }

   my $full_ldflags = "$ldflags $static_begin @vpr_libs@ $static_end";
   $full_ldflags    =~ s/\s{2,}/ /g;

   return "$full_ldflags";
}

sub make_EXTRA_LDFLAGS ($;$)
{
   my $extra_libs_arg = shift;
   my $use_linker     = shift || 0;

   if ( $extra_libs_arg =~ /n32/i )
   {
      $LIBBITSUF = '32';
   }
   elsif ( $extra_libs_arg =~ /64/ )
   {
      $LIBBITSUF = '64';
   }

   my $subsystem_libs    = "@subsystem_libs@";
   my $my_subsystem_libs = '';

   my $arg;
   foreach $arg ( split(/\s+/, "$subsystem_libs") )
   {
      $my_subsystem_libs .= " $arg" unless "$arg" eq "-L@libdir@";
   }

   my $extra_ldflags = ($use_linker ? "@vpr_extra_ldflags_linker@"
                                    : "@vpr_extra_ldflags_compiler@");

   my $full_extra_ldflags = "$extra_ldflags @vpr_extra_libs@ " .
                            "$my_subsystem_libs";
   $full_extra_ldflags    =~ s/\s{2,}/ /g;

   return "$full_extra_ldflags";
}

# Subroutine for handling command-line parameters that have an optional
# argument.
sub handleOptArg ($$)
{
   my $name  = shift;
   my $value = shift || '';

   SWITCH:
   {
      if ( "$name" eq "prefix" )
      {
         # If $value is defined, we set $prefix to its value.  The value of
         # $prefix will not be printed in this case.
         if ( $value )
         {
            $prefix      = "$value";
            $ECHO_PREFIX = 0;
            $PREFIX_SET  = 1;
         }
         # If $value is undefined, that means that --prefix was specified, but
         # no value was given.  In that case, we just want to print the
         # prefix.
         else
         {
            $ECHO_PREFIX = 1;
         }

         last SWITCH;
      }

      if ( "$name" eq "exec-prefix" )
      {
         # If $value is defined, we set $exec_prefix to its value.  The value
         # of $exec_prefix will not be printed in this case.
         if ( $value )
         {
            $exec_prefix      = "$value";
            $EXEC_PREFIX_SET  = 1;
            $ECHO_EXEC_PREFIX = 0;
         }
         # If $value is undefined, that means that --exec-prefix was specified,
         # but no value was given.  In that case, we just want to print the
         # exec prefix.
         else
         {
            $ECHO_EXEC_PREFIX = 1;
         }

         last SWITCH;
      }

      if ( "$name" eq "cxxflags" )
      {
         $ECHO_CXXFLAGS = 1;
         $cxxflags_arg  = $value;
         last SWITCH;
      }

      if ( "$name" eq "libs" )
      {
         $ECHO_LIBS = 1;
         $libs_arg  = $value;
         last SWITCH;
      }

      if ( "$name" eq "extra-libs" )
      {
         $ECHO_EXTRA_LIBS = 1;
         $extra_libs_arg  = $value;
         last SWITCH;
      }
   }
}
